<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tensorflow JS Inference</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>
<body class="w-[100vw] min-h-[100vh] my-[1em] flex flex-col justify-center items-center">
    <p class="text-xl font-black">Inference Tensorflow JS Image Classification</p>
    <div class="max-w-xl flex flex-col justify-center items-center">
        <br>
        <input type="file" id="image-upload" accept="image/*" class="border-1 cursor-pointer bg-gray-100">
        <br>
        <img id="image-preview" src="#" alt="Image Preview" style="display:none;">
        <br>
        <div id="prediction"></div>
    </div>
    <script>
        /*
        let model
        const dict = {0: 'Cloud', 1: 'Other', 2: 'Smoke'}

        async function loadModel(){
            try {
                console.log('Masuk.')
                model = await tf.loadGraphModel('tfjs_model/model.json')
                console.log('Model loaded successfully.')
            } catch (error) {
                console.log('Error loading model:', error)
            }
        }
        
        loadModel()
        
        function preprocessImage(image){
            const resizedImage = tf.image.resizeBilinear(image, [128, 128])
            const mean = resizedImage.mean()
            const variance = resizedImage.squaredDifference(mean).mean()
            const stdDev = variance.sqrt()
            const adjustedStdDev = stdDev.maximum(tf.scalar(1.0 / Math.sqrt(resizedImage.size)))
            const normalizedImage = resizedImage.sub(mean).div(adjustedStdDev)
            const batchedImage = normalizedImage.expandDims(0)
            return batchedImage;
        }

        async function predict(imageElement) {
            if (!model) {
                console.log('Model is not loaded yet.')
                return
            }

            const imageTensor = tf.browser.fromPixels(imageElement)
            const preprocessedImage = preprocessImage(imageTensor)
            const predictions = await model.predict(preprocessedImage)
            const predictedClass = predictions.argMax(1).dataSync()[0]
            document.getElementById('prediction').innerText = `Predicted Class: ${dict[predictedClass]}`
        }

        document.getElementById('image-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageElement = document.getElementById('image-preview');
                    imageElement.src = e.target.result;
                    imageElement.style.display = 'block';
                    imageElement.onload = function() {
                        predict(imageElement);
                    };
                };
                reader.readAsDataURL(file);
            }
        });
        */
        document.getElementById('image-upload').addEventListener('change', function (event) {
            const file = event.target.files[0]
            if(file){
                const reader = new FileReader()
                reader.onload = function (e) {
                    const imageElement = document.getElementById('image-preview')
                    imageElement.src = e.target.result
                    imageElement.style.display = 'block'
                    const formData = new FormData()
                    formData.append('image', file)
                    fetch('/predict', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Data:', data)
                        document.getElementById('prediction').innerText = `Predicted Class: ${data.predictedLabel}`
                    })
                    .catch(error => {
                        console.error('Error:', error)
                        document.getElementById('prediction').innerText = `Error during prediction`
                    })
                }
                reader.readAsDataURL(file)
            }
        })
    </script>
</body>
</html>